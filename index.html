<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shiny Pok√©mon Bingo</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '‚ú®';
      position: fixed;
      top: 10%;
      left: 10%;
      font-size: 3rem;
      animation: float 6s ease-in-out infinite;
      opacity: 0.3;
    }

    body::after {
      content: '‚≠ê';
      position: fixed;
      top: 70%;
      right: 15%;
      font-size: 2.5rem;
      animation: float 8s ease-in-out infinite;
      opacity: 0.4;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(10deg); }
    }

    main {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    h1 {
      text-align: center;
      color: white;
      font-size: 3.5rem;
      font-weight: 700;
      margin-bottom: 30px;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
      letter-spacing: 2px;
    }

    .controls {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: center;
    }

    .controls label {
      font-weight: 600;
      color: #333;
      font-size: 1.1rem;
    }

    #pokemonSelect {
      min-width: 280px;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #667eea;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    #pokemonSelect:hover {
      border-color: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    #addPokeBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #startGameBtn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    #saveBingoBtn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    #loadBingoBtn {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }

    button:active {
      transform: translateY(-1px);
    }

    #status {
      font-size: 1.3rem;
      font-weight: 700;
      color: #667eea;
      text-align: center;
      padding: 10px;
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border-radius: 12px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
    }

    #message {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      color: #f5576c;
      min-height: 30px;
      margin-top: 10px;
    }

    #bingoGrid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
    }

    .bingo-cell {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .bingo-cell::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .bingo-cell:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.3);
    }

    .bingo-cell:hover::before {
      opacity: 1;
    }

    .bingo-cell.found {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      border: 3px solid #fdcb6e;
      animation: celebrate 0.6s ease;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .bingo-cell.found::after {
      content: '‚úÖ';
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 2rem;
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .poke-img {
      width: 90px;
      height: 90px;
      object-fit: contain;
      margin-bottom: 12px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
      transition: transform 0.3s;
    }

    .bingo-cell:hover .poke-img {
      transform: scale(1.1) rotate(5deg);
    }

    .poke-name {
      font-weight: 600;
      color: #2d3436;
      text-align: center;
      margin-bottom: 12px;
      font-size: 15px;
      line-height: 1.3;
    }

    .poke-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.3s;
    }

    .poke-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .bingo-cell button {
      padding: 8px 16px;
      font-size: 13px;
      margin: 4px;
    }

    .edit-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .edit-icon:hover {
      background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
      color: white;
    }

    .check-btn {
      background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
      color: white;
      width: 90%;
    }

    .bingo-cell.found .check-btn {
      background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
    }

    .version {
      text-align: center;
      color: white;
      margin-top: 30px;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    @media (max-width: 1200px) {
      #bingoGrid {
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2.5rem;
      }

      #bingoGrid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .bingo-cell {
        min-height: 180px;
        padding: 15px;
      }

      .poke-img {
        width: 70px;
        height: 70px;
      }
    }

    @media (max-width: 480px) {
      #bingoGrid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>‚ú® Shiny Pok√©mon Bingo ‚ú®</h1>

    <div class="controls">
      <div class="control-row">
        <label for="pokemonSelect">Choisis un Pok√©mon :</label>
        <select id="pokemonSelect"></select>
        <button id="addPokeBtn">‚ûï Ajouter √† la grille</button>
      </div>
      <div class="control-row">
        <button id="startGameBtn">üîÑ Nouvelle Partie</button>
        <button id="saveBingoBtn">üíæ Sauvegarder</button>
        <button id="loadBingoBtn">üìÇ Charger JSON</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;">
      </div>
      <div id="status">0 / 30 coch√©s</div>
      <div id="message"></div>
    </div>

    <div id="bingoGrid"></div>

    <p class="version">Version 1.1 - Debug</p>
  </main>

  <script>
const rows = 5;
const cols = 6;
const totalCells = rows * cols;
const apiUrl = 'https://tyradex.app/api/v1/pokemon';

const bingoGrid = document.getElementById('bingoGrid');
const pokemonSelect = document.getElementById('pokemonSelect');
const addPokeBtn = document.getElementById('addPokeBtn');
const startGameBtn = document.getElementById('startGameBtn');
const saveBingoBtn = document.getElementById('saveBingoBtn');
const loadBingoBtn = document.getElementById('loadBingoBtn');
const fileInput = document.getElementById('fileInput');
const statusEl = document.getElementById('status');
const messageEl = document.getElementById('message');

let allPokemonData = [];
let bingoState = [];

function normalize(str) {
  return String(str || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]/g, "");
}

function detectRegion(name) {
  const n = normalize(name);
  if (n.includes("dalola") || n.includes("alola")) return "alola";
  if (n.includes("dgalar") || n.includes("galar")) return "galar";
  if (n.includes("dhisui") || n.includes("hisui")) return "hisui";
  if (n.includes("dpaldea") || n.includes("paldea")) return "paldea";
  return null;
}

function detectMega(name) {
  const n = normalize(name);
  return n.includes("mega");
}

function buildRegionalSprite(pokedexId, region, shiny = true) {
  const type = shiny ? "shiny" : "regular";
  return `https://raw.githubusercontent.com/Yarkis01/TyraDex/images/sprites/${pokedexId}/${type}_${region}.png`;
}

fetch(apiUrl)
  .then(r => r.json())
  .then(data => {
    allPokemonData = data || [];
    console.log('Total Pok√©mon charg√©s:', allPokemonData.length);
    populateSelect();
    initGridEmpty();
  })
  .catch(err => {
    console.error('Impossible de charger l\'API :', err);
    messageEl.textContent = "Erreur chargement API. Recharge la page.";
    allPokemonData = [];
    populateSelect();
    initGridEmpty();
  });

function populateSelect() {
  const select = pokemonSelect;
  select.innerHTML = "";

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "S√©lectionne un Pok√©mon...";
  select.appendChild(opt0);

  const allOptions = [];

  allPokemonData.forEach(p => {
    const baseName = p.name?.fr || p.name?.en || `ID ${p.pokedex_id}`;
    
    allOptions.push({
      id: p.pokedex_id,
      name: baseName,
      region: null,
      sortKey: baseName
    });
    
    if (p.formes && p.formes.length > 0) {
      p.formes.forEach(forme => {
        const displayName = forme.name?.fr || `${baseName} (${forme.region})`;
        allOptions.push({
          id: p.pokedex_id,
          name: displayName,
          region: forme.region,
          sortKey: displayName
        });
      });
    }
  });

  const sorted = allOptions.sort((a, b) => 
    a.sortKey.localeCompare(b.sortKey, "fr")
  );

  sorted.forEach(opt => {
    const option = document.createElement("option");
    option.value = opt.id;
    option.textContent = `${opt.name} (${opt.id})`;
    option.dataset.fr = opt.name;
    option.dataset.region = opt.region || '';
    select.appendChild(option);
  });
}

function initGridEmpty() {
  bingoState = Array.from({ length: totalCells }, () => ({
    name: '',
    id: '',
    region: '',
    checked: false
  }));
  renderGrid();
  updateStatus();
}

function renderGrid() {
  bingoGrid.innerHTML = "";

  bingoState.forEach((cellData, index) => {
    const cell = document.createElement("div");
    cell.className = "bingo-cell";
    if (cellData.checked) cell.classList.add("found");

    const creator = cellData.name ? createFilledCell : createEmptyCell;
    creator(cell, cellData, index);

    bingoGrid.appendChild(cell);
  });
}

function createEmptyCell(cell, cellData, index) {
  const input = document.createElement("input");
  input.className = "poke-input";
  input.placeholder = "Nom du Pok√©mon";
  input.value = "";

  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && input.value.trim()) {
      setCellPokemon(index, input.value.trim());
    }
  });

  const addBtn = document.createElement("button");
  addBtn.textContent = "Ajouter";
  addBtn.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
  addBtn.style.color = "white";
  addBtn.style.width = "90%";
  addBtn.onclick = () => {
    if (input.value.trim()) setCellPokemon(index, input.value.trim());
  };

  cell.appendChild(input);
  cell.appendChild(addBtn);
}

function createFilledCell(cell, cellData, index) {
  console.log("üì¶ createFilledCell appel√© avec:", {
    name: cellData.name,
    id: cellData.id,
    region: cellData.region
  });
  
  const res = rechercheParNomOuId(cellData.id, cellData.name, cellData.region);
  
  console.log("üîç R√©sultat de la recherche:", res);

  const img = document.createElement("img");
  img.className = "poke-img";
  img.alt = cellData.name;
  
  let spriteUrl = "";
  if (res?.sprites?.shiny) {
    spriteUrl = res.sprites.shiny;
  } else if (res?.sprites?.regular) {
    spriteUrl = res.sprites.regular;
  }
  
  console.log("üñºÔ∏è URL du sprite:", spriteUrl);
  img.src = spriteUrl;

  const nameEl = document.createElement("div");
  nameEl.className = "poke-name";
  nameEl.textContent = cellData.name;

  const editBtn = document.createElement("button");
  editBtn.className = "edit-icon";
  editBtn.textContent = "‚úé";
  editBtn.onclick = () => openEditor(index);

  const checkBtn = document.createElement("button");
  checkBtn.className = "check-btn";
  checkBtn.textContent = cellData.checked ? "D√©cocher" : "Cocher";
  checkBtn.onclick = () => toggleCheck(index);

  cell.appendChild(img);
  cell.appendChild(nameEl);
  cell.appendChild(editBtn);
  cell.appendChild(checkBtn);
}

addPokeBtn.addEventListener('click', () => {
  const sel = pokemonSelect.selectedOptions[0];
  if (!sel || !sel.value) {
    messageEl.textContent = "Choisis d'abord un Pok√©mon dans la liste.";
    return;
  }
  const frName = sel.dataset.fr;
  const region = sel.dataset.region || '';
  console.log("‚ûï Ajout du Pok√©mon:", {frName, id: sel.value, region});
  const idx = bingoState.findIndex(c => !c.name);
  if (idx === -1) {
    messageEl.textContent = "La grille est d√©j√† pleine.";
    return;
  }
  setCellPokemon(idx, frName, sel.value, region);
  messageEl.textContent = '';
});

startGameBtn.addEventListener('click', () => {
  if (!confirm('R√©initialiser la grille ?')) return;
  initGridEmpty();
  messageEl.textContent = 'Partie r√©initialis√©e.';
});

saveBingoBtn.addEventListener('click', () => {
  const toSave = bingoState.map(c => ({
    name: c.name,
    id: c.id,
    region: c.region,
    checked: c.checked
  }));
  const blob = new Blob([JSON.stringify(toSave, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'bingo_pokemon.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  messageEl.textContent = 'üíæ Bingo sauvegard√© localement.';
  messageEl.style.color = '#00b894';
});

loadBingoBtn.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = JSON.parse(event.target.result);
      
      if (!Array.isArray(data)) {
        messageEl.textContent = '‚ùå Format JSON invalide : doit √™tre un tableau.';
        messageEl.style.color = '#f5576c';
        return;
      }

      if (data.length !== totalCells) {
        messageEl.textContent = `‚ùå Le fichier doit contenir exactement ${totalCells} cases (trouv√©: ${data.length}).`;
        messageEl.style.color = '#f5576c';
        return;
      }

      bingoState = data.map(cell => ({
        name: cell.name || '',
        id: cell.id || '',
        region: cell.region || '',
        checked: cell.checked || false
      }));

      renderGrid();
      updateStatus();
      messageEl.textContent = '‚úÖ Bingo charg√© avec succ√®s !';
      messageEl.style.color = '#00b894';
      fileInput.value = '';
      
    } catch (err) {
      console.error('Erreur de parsing JSON:', err);
      messageEl.textContent = '‚ùå Erreur : fichier JSON invalide.';
      messageEl.style.color = '#f5576c';
    }
  };

  reader.onerror = () => {
    messageEl.textContent = '‚ùå Erreur lors de la lecture du fichier.';
    messageEl.style.color = '#f5576c';
  };

  reader.readAsText(file);
});

function setCellPokemon(index, name, id = '', region = '') {
  if (!region) {
    region = detectRegion(name);
  }
  
  console.log("üíæ setCellPokemon:", {index, name, id, region});
  
  bingoState[index].name = name;
  bingoState[index].id = id || findIdByName(name) || '';
  bingoState[index].region = region || '';
  bingoState[index].checked = false;
  
  console.log("üíæ bingoState[index] apr√®s mise √† jour:", bingoState[index]);
  
  renderGrid();
  updateStatus();
}

function openEditor(index) {
  bingoState[index].name = '';
  renderGrid();
  const input = bingoGrid.children[index]?.querySelector('input');
  if (input) input.focus();
}

function toggleCheck(index) {
  bingoState[index].checked = !bingoState[index].checked;
  renderGrid();
  updateStatus();
  messageEl.textContent = isComplete()
    ? "üéâ Bingo complet ! Toutes les cases sont coch√©es."
    : '';
}

function updateStatus() {
  const count = bingoState.filter(c => c.checked).length;
  statusEl.textContent = `${count} / ${totalCells} coch√©s`;
}

function isComplete() {
  return bingoState.every(c => c.checked);
}

function rechercheParNomOuId(idOrName, fallbackName, region) {
  console.log("üîé rechercheParNomOuId appel√© avec:", {idOrName, fallbackName, region});
  
  if (!allPokemonData || allPokemonData.length === 0) {
    console.log("‚ùå Pas de donn√©es Pok√©mon");
    return null;
  }

  const rawName = fallbackName || idOrName;
  const key = normalize(rawName);
  
  const isMega = key.includes("mega");
  
  const cleanedKey = key
    .replace("dalola", "")
    .replace("dealola", "")
    .replace("dgalar", "")
    .replace("degalar", "")
    .replace("dhisui", "")
    .replace("dehisui", "")
    .replace("dpaldea", "")
    .replace("depaldea", "")
    .replace("mega", "")
    .trim();

  console.log("üßπ Nom nettoy√©:", cleanedKey);

  let basePokemon = null;
  
  if (idOrName && !isNaN(idOrName)) {
    basePokemon = allPokemonData.find(p => 
      String(p.pokedex_id) === String(idOrName)
    );
    console.log("üî¢ Recherche par ID:", idOrName, "trouv√©:", !!basePokemon);
  }
  
  if (!basePokemon) {
    const candidates = allPokemonData.filter(p => {
      const nameFr = normalize(p.name?.fr || "");
      const nameEn = normalize(p.name?.en || "");
      return nameFr === cleanedKey || nameEn === cleanedKey;
    });
    
    console.log("üéØ Candidats trouv√©s:", candidates.length);
    
    basePokemon = candidates.find(p => !p.formes || p.formes.length === 0);
    
    if (!basePokemon && candidates.length > 0) {
      basePokemon = candidates[0];
    }
  }

  if (!basePokemon) {
    console.log("‚ùå Pok√©mon de base non trouv√©");
    return null;
  }

  console.log("‚úÖ Pok√©mon trouv√©:", basePokemon.name?.fr, "ID:", basePokemon.pokedex_id);

  if (isMega && basePokemon.evolution?.mega) {
    const megas = Array.isArray(basePokemon.evolution.mega) 
      ? basePokemon.evolution.mega 
      : [basePokemon.evolution.mega];
    
    if (megas.length > 0) {
      const mega = megas[0];
      console.log("üî∑ M√©ga-√©volution:", mega.sprites);
      return {
        sprites: mega.sprites,
        name: "M√©ga-" + (basePokemon.name?.fr || basePokemon.name?.en)
      };
    }
  }

  if (region) {
    console.log("üåç Forme r√©gionale demand√©e:", region);
    
    if (basePokemon.formes && basePokemon.formes.length > 0) {
      const forme = basePokemon.formes.find(f => f.region === region);
      if (forme && forme.sprites) {
        console.log("‚úÖ Forme trouv√©e dans l'API avec sprites:", forme.sprites);
        return {
          sprites: forme.sprites,
          name: forme.name?.fr || basePokemon.name?.fr
        };
      }
    }
    
    const manualSprites = {
      shiny: buildRegionalSprite(basePokemon.pokedex_id, region, true),
      regular: buildRegionalSprite(basePokemon.pokedex_id, region, false)
    };
    console.log("üî® Construction manuelle des sprites:", manualSprites);
    return {
      sprites: manualSprites,
      name: basePokemon.name?.fr || basePokemon.name?.en
    };
  }

  console.log("üì∑ Sprites forme normale:", basePokemon.sprites);
  return {
    sprites: basePokemon.sprites,
    name: basePokemon.name?.fr || basePokemon.name?.en
  };
}

function findIdByName(name) {
  if (!name) return '';
  const key = normalize(name)
    .replace("dalola", "")
    .replace("dealola", "")
    .replace("dgalar", "")
    .replace("degalar", "")
    .replace("dhisui", "")
    .replace("dehisui", "")
    .replace("dpaldea", "")
    .replace("depaldea", "")
    .replace("mega", "")
    .trim();

  const p = allPokemonData.find(p => {
    const nameFr = normalize(p.name?.fr || "");
    const nameEn = normalize(p.name?.en || "");
    return (nameFr === key || nameEn === key) && 
           (!p.formes || p.formes.length === 0);
  });
  
  return p ? (p.pokedex_id || '') : '';
}
  </script>
</body>
</html>
